#!/bin/bash
# Copyright 2018 Jordon Bedwell. All rights reserved.
# Use of this source code is governed by the MIT license
# that can be found in the LICENSE file.
[[ "$DEBUG" ]] && set -x
set -e

b="bins"; d="$PWD"
v=$(go version | awk '{ print $3 }' | sed -e 's/^go//')
r=$(cat go.mod | grep module | sed -e 's/^module[[:space:]]*//')
n="$(basename "$d")"

docker pull golang:"$v"
rm -r "$d/$b" && mkdir -p "$d/$b"
docker rm -f "$n" || true

docker run --name="$n" --env=CGO_ENABLE=0 \
  --env=GO111MODULE=on --volume="$d/$b:/$b" \
  --workdir="/.go/src/$r" --detach --interactive \
  --tty golang:"$v" sh

docker exec "$n" mkdir -p "/.go/src/$r"
docker cp . "$n":"/.go/src/$r"
if [[ "$1" ]]; then
  docker exec "$n" git reset HEAD --hard
  docker exec "$n" git \
    checkout "$1"
fi

build() {
  docker exec "$n" env GOOS=$1 GOARCH=$2 \
    go build -v -ldflags \
      '-s -w' -o $3
}

build linux   amd64 "/$b/$n-linux-amd64"
build darwin  amd64 "/$b/$n-darwin-amd64"
build windows amd64 "/$b/$n-windows-amd64"
build linux   arm64 "/$b/$n-linux-arm64"
build linux   arm   "/$b/$n-linux-arm"

docker rm -f "$n"
if [[ "$SIGN" != "false" ]] && [[ "$MACOS_DEVELOPER_ID" ]]; then
  codesign -f -s "$MACOS_DEVELOPER_ID" \
    "$d/$b/$n-darwin"-*
fi
